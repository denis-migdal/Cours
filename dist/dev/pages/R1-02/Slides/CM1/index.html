<!DOCTYPE html>
<html>
<head>
    <title>BDR CM1</title>
    <link rel="stylesheet" href="./index.css">
    <script src="./index.js" type="module" defer></script>
</head>
<body>
<main>
<frame-uca-title
    caption   = "R1-02 Bases de Donn√©es Relationnelles"
    subcaption= "CM1 : Requ√™ter une base de donn√©es"
    author    = "Denis MIGDAL"
    mail      = "denis.migdal@uca.fr">
</frame-uca-title>

<frame-section>
    Introduction √† SQL
</frame-section>
<frame-subsection>
    Les SGBD
</frame-subsection>

<frame-uca>

<p><em><strong>Contexte :</strong></em> des milliers/millions de donn√©es √† manipuler, e.g.</p>
<!--
- *pour une entreprise* : des listes de clients, de commandes, de produits, etc.
- *pour une administration* : des listes d'administr√©s, de transactions, etc.
- *pour un site Web* : des logs de consultation de ses diff√©rentes pages, etc. -->

<p><em><strong>Probl√®me :</strong></em> les manipuler &quot;√† la main&quot; est...</p>
<ul>
<li><strong>chronophage</strong> : <em>35 jours pour un million de donn√©es (1 donn√©e/s et 8h/j).</em></li>
<li><strong>source d&#39;erreurs</strong> : <em>donn√©es compt√©es en double, saut√©es, etc.</em></li>
<li><strong>incomplet</strong> : <em>donn√©es stock√©es √† plusieurs endroits diff√©rents, certaines perdues.</em></li>
</ul>
<p><em><strong>Besoins :</strong></em> un logiciel permettant d&#39;efficacement...</p>
<ul>
<li><strong>stocker et organiser les donn√©es</strong>.</li>
<li><strong>manipuler les donn√©es</strong> : ajouter/modifier/supprimer des donn√©es.</li>
<li><strong>requ√™ter les donn√©es</strong> : e.g. compter le nombre de ventes.</li>
</ul>
</frame-uca>
<frame-uca>

<p><em><strong>Solution :</strong></em> les <strong>Syst√®mes de Gestion de Bases de Donn√©es</strong> (SGBD) :</p>
<ul>
<li><strong>cr√©er, stocker, manipuler et requ√™ter des bases de donn√©es.</strong></li>
<li><strong>la coh√©rence des donn√©es :</strong> garantie l&#39;absence de donn√©es invalides.<br/><!-- *e.g. avoir un √¢ge n√©gatif.* --></li>
<li><strong>la robustesse :</strong> r√©sister aux pannes.<br/><!-- *e.g. l'ordinateur plante alors qu'on est en train de modifier une donn√©e.* --></li>
<li><strong>le contr√¥le d&#39;acc√®s :</strong> qui peut faire quoi sur quelles donn√©es ?.<br/><!-- *e.g. l'administrateur peut modifier et les utilisateurs lire les donn√©es.* --></li>
<li><strong>les logs :</strong> que s&#39;est-il pass√© ? qui a fait quoi et quand ?<br/><!-- *e.g. apr√®s une panne, qu'√©tait-il en train de faire ?*<br/> -->
<!-- *e.g. le stagiaire a fait une fausse manipulation, qu'a-t-il r√©ellement fait ?* --></li>
<li><strong>acc√®s concurrent :</strong> modifications simultan√©es de donn√©es.</li>
</ul>
</frame-uca>

<frame-subsection>
    Les SGBD SQL
</frame-subsection>

<frame-uca>

<p><strong>SQL</strong> (<em>Structured Query Language</em>) : langage pour manipuler des SGBD.</p>
<p>Exemples de SGBD SQL :</p>
<ul>
<li><strong>SQLite</strong> : l√©ger (utilis√© en TP)<ul>
<li>1 base de donn√©e = 1 fichier.</li>
<li>utilisation locale.</li>
<li>pas d&#39;acc√®s concurrents.</li>
</ul>
</li>
<li><strong>PostgreSQL</strong>, <strong>MySQL</strong>, et <strong>MariaDB</strong> : plus complets.</li>
</ul>
<p>‚ö† SQL est <em>normalis√©</em> (ISO/CEI 9075) mais quelques diff√©rences entre SGBD.</p>
</frame-uca>


<frame-uca>

<p>Les SGBD (sauf SQLite) suivent une <strong>architecture client-serveur</strong> :</p>
<ul>
<li><strong>serveur</strong> : stocke les donn√©es et ex√©cute les requ√™tes.</li>
<li><strong>client</strong> : envoie les requ√™tes et r√©ceptionne les r√©sultats.</li>
</ul>
<p>Plusieurs types de clients :</p>
<ul>
<li><strong>API</strong> utilis√©e dans le langage de programmation de votre choix.</li>
<li><strong>application en ligne de commandes</strong> (<em>e.g. psgl, mysql</em>).</li>
<li><strong>interface graphique de gestion de bases de donn√©es</strong> (<em>e.g. pgAdmin</em>).</li>
<li><strong>interface graphique de requ√™tage</strong> (<em>e.g.  ???</em>).</li>
</ul>
</frame-uca>

<frame-subsection>
    Les tables SQL
</frame-subsection>

<frame-uca>

<p>Une <strong>base de donn√©e</strong> est compos√©e de <strong>tables SQL</strong> (tableau contenant les donn√©es) :</p>
<center>
<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Nom</th>
      <th>Prenom</th>
      <th>Age</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>Doe</td>
      <td>John</td>
      <td>32</td>
    </tr><tr>
      <td>2</td>
      <td>Durand</td>
      <td>John</td>
      <td>64</td>
    </tr>
  </tbody>
</table>
</center>

<ul>
<li>lignes : les <strong>entr√©es</strong> (ou <strong>enregistrements</strong>);</li>
<li>colonnes : les <strong>propri√©t√©s</strong> des entr√©es.</li>
</ul>
<p>üí° base de donn√©es ‚âà fichier tableur ; tables ‚âà feuilles de calculs.</p>
<p>üí° Les tables sont aussi appel√©es <strong>relations</strong>, d&#39;o√π les <em>base de donn√©es relationnelle</em>.</p>
</frame-uca>

<frame-subsection>
    Les types SQL
</frame-subsection>

<frame-uca>

<p><strong>Sch√©ma</strong> de table : d√©crit la <strong>structure</strong> de la table, e.g. le type des colonnes :</p>
<ul>
<li><code>TEXT</code> :¬†une cha√Æne de caract√®re (e.g. <code>&#39;Hello&#39;</code> / <code>&#39;J&#39;&#39;ai mang√©&#39;</code>).</li>
<li><code>INT</code>/<code>INTEGER</code> : un nombre entier.</li>
<li><code>REAL</code> : un nombre d√©cimal.</li>
<li><code>BLOB</code> : des donn√©es binaires.</li>
<li><code>ANY</code>  :¬†accepte n&#39;importe quelle valeur.</li>
</ul>
<p>üí° Par d√©faut, chaque type accepte la valeur <code>NULL</code> (= absence de donn√©es).</p>
<p>üí° D&#39;autres types disponibles en fonction du SGBD utilis√©.</p>
</frame-uca>

<frame-subsection>
    Documentation
</frame-subsection>

<frame-uca>

<p>üí° Vous trouver plus amples documentation via les liens suivants :</p>
<ul>
<li>SQL :<ul>
<li><a href="https://www.w3schools.com/sql/">https://www.w3schools.com/sql/</a></li>
<li><a href="https://sql.sh">https://sql.sh</a></li>
</ul>
</li>
<li>SGBD :<ul>
<li>SQLite¬†:¬†<a href="https://www.sqlite.org">https://www.sqlite.org</a></li>
<li>PostgreSQL¬†:¬†<a href="https://www.postgresql.org/docs/">https://www.postgresql.org/docs/</a></li>
<li>MySQL : <a href="https://dev.mysql.com/doc/">https://dev.mysql.com/doc/</a></li>
</ul>
</li>
</ul>
</frame-uca>

<frame-section>
    Requ√™tes de bases
</frame-section>
<frame-subsection>
    Les types de requ√™tes
</frame-subsection>

<frame-uca>

<p>Plusieurs types de <strong>commandes SQL</strong> pour diff√©rent types d&#39;actions :</p>
<ul>
<li><code>SELECT</code> : <strong>lire</strong> des donn√©es ;</li>
<li><code>UPDATE</code> : <strong>modifier</strong> des entr√©es ;</li>
<li><code>INSERT</code> : <strong>ins√©rer</strong> des entr√©es ;</li>
<li><code>DELETE</code> : <strong>supprimer</strong> des entr√©es.</li>
</ul>
<p>üí° Nous allons nous concentrer sur <code>SELECT</code> et verrons les autres par la suite.</p>
</frame-uca>

<frame-section>
    Requ√™tes SELECT
</frame-section>

<frame-uca>

<p><code>SELECT</code> <strong>r√©cup√®re</strong> des donn√©es d&#39;une table :</p>
<pre><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> $COLS[,...] <span class="hljs-keyword">FROM</span> $<span class="hljs-keyword">TABLE</span>; 
</code></pre><ul>
<li><code>$TABLE</code> : nom de la table SQL √† requ√™ter.</li>
<li><code>$COLS[,...]</code> : liste des colonnes √† r√©cup√©rer (s√©par√©es par &quot;,&quot;).<br/>
üí° <code>*</code> correspond √† l&#39;ensemble des colonnes.</li>
</ul>
<p>‚ö† Ne r√©cup√©rer que les colonnes n√©cessaires (r√©duire les donn√©es transf√©r√©es). </p>
<p>‚ö† Le nom de la colonne entre guillemets si caract√®res non-alphanum√©riques.</p>
</frame-uca>

<frame-subsection>
    S√©lection de colonnes
</frame-subsection>

<frame-uca>

<center>
    <sql-dymtable id="col-table" table="Users"></sql-dymtable>
</center>

<sql-interactive id="col-sql">
  <span onslide="0" slot="options" data-cols="*">Retourner toutes les colonnes</span>
  <span onslide="1" slot="options" data-cols="Nom">Retourner une seule colonne</span>
  <span onslide="2" slot="options" data-cols="ID, Prenom">Retourner plusieurs colonnes</span>

<pre><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> $COLS <span class="hljs-keyword">FROM</span> Users;
</code></pre></sql-interactive>

<script>
</script>

<script>
    async function fct(parent) {

        const coltable = await LISS.qs("#col-table", parent);
        const colsql   = await LISS.qs("#col-sql"  , parent);

        colsql.host.addEventListener("change", (ev) => {
            update(ev.detail.datas);
        });
        update( colsql.lastDatas );

        function update(datas) {

            const cols = Object.keys(datas[0][0]);

            coltable.highlightCol( (colname) => cols.includes(colname) );
        }
    }

    {
        const parent = document.currentScript.closest("frame-uca");
        (parent.scripts ??= []).push( fct );
    }
    //fct(parent);
</script>

</frame-uca>

<frame-subsection>
    Alias de colonnes
</frame-subsection>

<frame-uca>

<p>üí° Associer (temporairement) un alias √† une colonne (<code>as</code>) :</p>
<sql-interactive>
  <span onslide="0" slot="options" data-col_as="">Requ√™te normale</span>
  <span onslide="1" slot="options" data-col_as="as User">Renommer une colonne</span>

<pre><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> Nom $COL_AS, Age <span class="hljs-keyword">FROM</span> Users;
</code></pre></sql-interactive>

</frame-uca>

<frame-subsection>
    Trier par ordre croissant/d√©croissant les lignes
</frame-subsection>

<frame-uca>

<p><code>ORDER BY $COL [DESC|ASC][,...]</code> trier les lignes par ordre croissant (<code>ASC</code>) ou d√©croissant (<code>DESC</code>).</p>
<sql-interactive>
  <span onslide="0" slot="options" data-row_sort="Age ASC">Trier par Age croissant</span>
  <span onslide="1" slot="options" data-row_sort="Age DESC">Trier par Age d√©croissant</span>
  <span onslide="2" slot="options" data-row_sort="Age DESC, Nom ASC">Trier par Age d√©croissant, puis par Nom croissant</span>

<pre><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> Users <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> $ROW_SORT;
</code></pre></sql-interactive>

</frame-uca>

<frame-section>
    Selection des lignes
</frame-section>

<frame-uca>

<p><code>SELECT</code> retourne <em>toutes</em> les entr√©es =&gt; consommation internet, processeur, RAM, disque.</p>
<p>S√©lectionner lignes pertinentes =&gt; - de ressources :</p>
<ul>
<li><strong>filtrer</strong> : <code>WHERE $COND</code>.</li>
<li><strong>supprimer doublons</strong> : <code>DISTINCT</code>.</li>
<li><strong>limiter nombre de lignes</strong> : <code>LIMIT $N OFFSET $O</code>.</li>
</ul>
</frame-uca>

<frame-subsection>
    Clause WHERE
</frame-subsection>

<frame-uca>

<center>
    <sql-dymtable id="row-table" table="Users"></sql-dymtable>
</center>

<sql-interactive id="row-sql">
  <span onslide="0" slot="options" data-cond="Age > 18">Entr√©es o√π Age > 18</span>
  <span onslide="1" slot="options" data-cond="Nom == 'Doe'">Entr√©es o√π Nom est "Doe"</span>

<pre><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> Users
         <span class="hljs-keyword">WHERE</span> $COND;
</code></pre></sql-interactive>

<p><code>WHERE¬†$COND</code> : les lignes o√π <code>$COND</code> vraie sont retourn√©es.</p>
<script>

    async function fct(parent) {

        const rowtable = await LISS.qs("#row-table", parent);
        const rowsql   = await LISS.qs("#row-sql"  , parent);

        rowsql.host.addEventListener("change", (ev) => {
            update(ev.detail.datas);
        });
        update( rowsql.lastDatas );

        function update(datas) {

            const ids = datas[0].map(r => r.ID);

            rowtable.highlightRow( ({ID}) => ids.includes(+ID) );
        }

    }

    {
        const parent = document.currentScript.closest("frame-uca");
        (parent.scripts ??= []).push( fct );
    }

    //fct(parent);
</script>

</frame-uca>
<frame-subsubsection>Op√©rateurs de comparaisons</frame-subsubsection>
<frame-uca>

<sql-interactive>
  <span onslide="0" slot="options" data-cond="ID > 1">Comparaison simple</span>
  <span onslide="1" slot="options" data-cond="Prenom == Nom">Comparaison entre 2 colonnes</span>
  <span onslide="2" slot="options" data-cond="0 < Age < 18">Cha√Æner les op√©rateurs produit un r√©sultat √©trange</span>

<pre><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> Age, Nom, Prenom <span class="hljs-keyword">FROM</span> Users <span class="hljs-keyword">WHERE</span> $COND;
</code></pre></sql-interactive>

<p onslide="0">üí° Op√©rateurs de comparaison : `>`, `<`, `>=`, `<=`, `!=`.</p>

<p onslide="1">üí° Op√©randes peuvent √™tre noms de colonnes, m√™me si non retourn√©e.</p>

<p onslide="2">‚ö† <strong>Ne JAMAIS cha√Æner les op√©rateurs de comparaisons</strong>.</p>
<ul onslide="2">
  <li>soit <code>0 < Age AND Age < 18</code> ;</li>
  <li>soit <code>Age BETWEEN 0 AND 18</code> .</li>
</ul>

</frame-uca>
<frame-subsubsection>Op√©rateurs logiques</frame-subsubsection>
<frame-uca>

<p>Op√©rateurs logiques : <code>AND</code>, <code>OR</code>, <code>NOT</code>.</p>
<sql-interactive>
  <span onslide="0" slot="options" data-cond="Age > 18 AND Age < 45">Intersection (et)</span>
  <span onslide="1" slot="options" data-cond="Age > 18 OR Age < 45">Union (ou)</span>
  <span onslide="2" slot="options" data-cond="NOT ( Age > 18 )">N√©gation (non)</span>

<pre><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> Age, Nom, Prenom <span class="hljs-keyword">FROM</span> Users <span class="hljs-keyword">WHERE</span> $COND;
</code></pre></sql-interactive>

<p>üí° Vous pouvez aussi utiliser des parenth√®ses.</p>
</frame-uca>
<frame-subsubsection>Autres op√©rateurs</frame-subsubsection>
<frame-uca>

<ul>
    <li onslide="0"><code>[NOT] IS NULL</code> : la valeur est nulle/n'est pas nulle.<br/>
  ‚ö† En SQL <code>NULL == NULL</code> est g√©n√©ralement √©valu√© √† <code>False</code>.</li>
    <li onslide="1"><code>[NOT] IN ($VALS[,...])</code> : la valeur est/n'est pas dans une liste donn√©e.</li>
    <li onslide="2"><code>[NOT] BETWEEN $MIN AND $MAX</code> : la valeur est/n'est pas entre <code>$MIN</code> et <code>$MAX</code>.<br/>
  üí° √âquivalant √† <code>$VAL >= $MIN AND $VAL <= $MAX</code><br/>
  ‚ö† Comportement de <code>BETWEEN</code> peut varier, e.g. <code>$VAL > $MIN AND $VAL < $MAX</code>.</li>
    <li onslide="3"><code>[NOT] LIKE $PATTERN</code> : la valeur correspond/ne correspond pas √† <code>$PATTERN</code>.
    <ul>
        <li><code>_</code> n'importe quel caract√®re.</li>
        <li><code>%</code> nombre ind√©termin√© de `_`.</li>
    </ul>
    e.g. <code>LIKE 'D%'</code>: commence par "D".</li>
</ul>

<sql-interactive>
  <span onslide="0" slot="options" data-cond="Age IS NULL">Entr√©es o√π Age vaut null</span>
  <span onslide="1" slot="options" data-cond="Nom IN ('Doe', 'Nescio')">Entr√©es o√π Nom est dans la liste</span>
  <span onslide="2" slot="options" data-cond="Age BETWEEN 0 AND 18">Entr√©es o√π Age est compris entre 0 et 18</span>
  <span onslide="3" slot="options" data-cond="Nom LIKE 'D%'">Entr√©es o√π Nom commence par "D"</span>

<pre><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> Age, Nom, Prenom <span class="hljs-keyword">FROM</span> Users <span class="hljs-keyword">WHERE</span> $COND;
</code></pre></sql-interactive>

</frame-uca>
<frame-uca>

<frame-section>
    Supprimer les doublons
</frame-section>

<p><code>DISTINCT</code> : supprime les doublons :</p>
<sql-interactive>
  <span onslide="0" slot="options" data-row_distinct="">Requ√™te normale</span>
  <span onslide="1" slot="options" data-row_distinct="DISTINCT">Ne pas retourner les doublons</span>

<pre><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> $ROW_DISTINCT Age <span class="hljs-keyword">FROM</span> Users;
</code></pre></sql-interactive>

</frame-uca>

<frame-subsection>
    Tops et pagination
</frame-subsection>
<frame-subsubsection>
    Tops
</frame-subsubsection>

<frame-uca>

<p><code>LIMIT $N</code> : r√©cup√®re les <code>$N</code> premi√®res entr√©es.</p>
<sql-interactive>
  <span onslide="0" slot="options" data-pagination="1">Ne r√©cup√©rer que la premi√®re entr√©e</span>
  <span onslide="1" slot="options" data-pagination="2">Ne r√©cup√©rer que les deux premi√®res entr√©es</span>
  <span onslide="2" slot="options" data-orderby="ORDER BY Age" data-pagination="1">Ne r√©cup√©rer que l'utilisateur le plus jeune</span>

<pre><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> Users $ORDERBY LIMIT $PAGINATION;
</code></pre></sql-interactive>

<p onslide="2">

<p>üí° Avec la clause <code>ORDER BY</code>, g√©n√®re des tops, e.g. les X utilisateurs les plus jeunes.</p>
</p>


</frame-uca>
<frame-subsubsection>
    Pagination
</frame-subsubsection>
<frame-uca>

<p><em><strong>Probl√®me</strong></em> :</p>
<ul>
<li>R√©cup√©rer et afficher milliers de lignes =&gt; co√ªteux.</li>
</ul>
<p><em><strong>Solution</strong></em> :</p>
<ul>
<li>D√©couper la liste en plusieurs pages (e.g. 50 lignes/page).</li>
</ul>
<p><em><strong>En SQL</strong></em> :</p>
<ul>
<li><code>LIMIT 50</code> : 50 entr√©es par requ√™tes.</li>
<li><code>OFFSET $P*50</code> (<code>$P+1</code> = la page) r√©cup√©rer √† partir de la <code>$P*50</code>-i√®me entr√©e.</li>
</ul>
</frame-uca>
<frame-uca>

<center>
    <sql-dymtable id="pagination-table" table="Users"></sql-dymtable>
</center>

<sql-interactive id="pagination-sql">
  <span onslide="0" slot="options" data-pagination="1" data-p="0">Page 1 (1 entr√©e par page)</span>
  <span onslide="1" slot="options" data-pagination="1" data-p="1">Page 2 (1 entr√©e par page)</span>
  <span onslide="2" slot="options" data-pagination="1" data-p="2">Page 3 (1 entr√©e par page)</span>
  <span onslide="3" slot="options" data-pagination="2" data-p="0*2">Page 1 (2 entr√©e par page)</span>
  <span onslide="4" slot="options" data-pagination="2" data-p="1*2">Page 2 (2 entr√©e par page)</span>

<pre><code class="hljs language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> Users LIMIT  $PAGINATION
                    <span class="hljs-keyword">OFFSET</span> $P ;
</code></pre></sql-interactive>

<script>
    async function fct(parent) {

        const table = await LISS.qs("#pagination-table", parent);
        const sql   = await LISS.qs("#pagination-sql"  , parent);

        sql.host.addEventListener("change", (ev) => {
            update(ev.detail.datas);
        });
        update( sql.lastDatas );

        function update(datas) {

            const ids = datas[0].map(r => r.ID);
            table.highlightRow( ({ID}) => ids.includes(+ID) );
  }
    }

    {
        const parent = document.currentScript.closest("frame-uca");
        (parent.scripts ??= []).push( fct );
    }
</script>
</frame-uca>

<frame-section>
    Astuces pour r√©diger efficacement les requ√™tes SQL
</frame-section>

<frame-uca>

<ol>
<li>Indentez vos requ√™tes (e.g. aligner les clauses), + lisible + facile √† modifier.</li>
<li>Fermez imm√©diatement parenth√®se/guillemet/etc. avant de la remplir.</li>
<li>√âvitez autant que possible d&#39;√©crire √† la main :<ol>
<li>Utilisez l&#39;auto-compl√©tion (touche de tabulation <code>‚≠æ</code>).</li>
<li>Utilisez (<code>‚Üë</code>/<code>‚Üì</code>) pour remonter l&#39;historique et (<code>‚Üê</code>/<code>‚Üí</code>) pour modifier une requ√™te.</li>
<li>Utilisez les copier/coller (<code>^+‚áß+C</code>/<code>^+‚áß+V</code>).</li>
</ol>
</li>
<li>Ne <strong>jamais</strong> tout √©crire d&#39;un coup, mais proc√©dez par √©tapes :<ol>
<li><code>SELECT * FROM $T;</code> basique.</li>
<li>afficher les colonnes pertinentes.</li>
<li>ajoutez et testez les clauses une par une.</li>
<li>idem pour les expressions, ajoutez les op√©rations au fur et √† mesure.</li>
</ol>
</li>
</ol>
<p>Avantages :</p>
<ul>
<li>√©criture + simple, rigoureux et m√©thodique.</li>
<li>1 probl√®me complexe =&gt; petits probl√®mes simples.</li>
<li>debug + simple : origine probl√®me tout de suite connu.</li>
</ul>
</frame-uca>

<frame-subsection>
    Ordre d'ex√©cution et d'√©criture (de gauche √† droite)
</frame-subsection>
<frame-uca>

<p><span onslide="7"></span><!-- h4ck --></p>
<style>
  .later {
    color: gray;
    font-style: italic;
    opacity: 0.5;
  }
  .warning {
    color: red;
  }

  #order-list {
    margin: 0;
  }

</style>

<div style="display:flex">
  <ol id="order-list">
    <li step="1">R√©cup√®re table (<code>FROM</code>).</li>
    <li step="2" class="warning"><em>Alias de colonnes.</em></li>
    <li step="3">Filtre entr√©es (<code>WHERE</code>).</li>
    <li class="later">Groupe entr√©es (<code>GROUP BY</code>).</li>
    <li class="later warning"><em>Alias de colonnes d'agr√©gats.</em></li>
    <li class="later">Filtre lignes agr√©g√©es (<code>HAVING</code>).</li>
    <li class="warning" step="4">Supprime doublons (<code>SELECT DISTINCT</code>).</li>
    <li step="5">Trie les lignes (<code>ORDER BY</code>).</li>
    <li step="6">Limite lignes (<code>LIMIT</code>/<code>OFFSET</code>).</li>
  </ol>
  <div>
    <!--<div style="text-align: center">
      <anim-player speed="1500" id="order-player"></anim-player>
    </div>-->
    <div style="display:flex;height: fit-content;">
      <style>
        .notyet {
          color: gray;
        }
        .cur {
          color: yellow;
        }
        .warning.cur {
          color: orange;
        }
      </style>
      <pre style="margin:0"><code id="order_sql">SELECT <span class="notyet">DISTINCT</span> Date, Ref, Q as Nb
    FROM Produits
    WHERE Ref = "Gomme"
    ORDER BY Q
    LIMIT 2;</code></pre>
      <sql-dymtable header="" table="Produits" id="order-table"><sql-dym-table>>
    </div>
  </div>
</div>

<script>
    async function fct(parent) {

        //const player = await LISS.qs("#order-player", parent);
        const table  = await LISS.qs("#order-table", parent);
        const order_sql = parent.querySelector("#order_sql");

        const list = parent.querySelectorAll("#order-list > li");

        const query = [
        `SELECT `, [4, `DISTINCT `], `Date, Ref, Q `, [2, "as Nb"],
            [ 1, `\n    FROM Produits`],
            [ 3, `\n    WHERE Ref = 'Gomme'`],
            [ 5, `\n    ORDER BY Q`],
            [ 6, `\n    LIMIT 2`], ';' ];

        function buildQuery(step) {
            let output = "";
            for(let elem of query) {
            if( Array.isArray(elem) ) {
                if( elem[0] > step && step !== 0 )
                continue;
                elem = elem[1];
            }
            output += elem;
            }

            return output;
        }
        function buildOutput(step) {
            let output = [];
            for(let elem of query) {
            if( Array.isArray(elem) ) {
                const html = document.createElement('span');
                html.textContent = elem[1];
                html.classList.toggle("cur", elem[0] === step);
                
                if( elem[0] > step && step !== 0 )
                html.classList.add("notyet");
                elem = html;
            }
            output.push(elem);
            }

            return output;
        }

        function doStep(i) {

            if( i > 6)
                return; //return player.reset();

            order_sql.replaceChildren( ...buildOutput(i) ); //TODO highlight
            for(let li of list)
                li.classList.toggle("cur", li.getAttribute("step") === `${i}`);

            table.exec( buildQuery(i) );
        }

        //player.host.addEventListener("reset", ()   => { doStep(0)          });
        //player.host.addEventListener("step" , (ev) => { console.warn(ev.detail); doStep( ev.detail) });

        //doStep(0);
        doStep(+parent.getAttribute("slide") );
    }

    {
        const parent = document.currentScript.closest("frame-uca");
        (parent.scripts ??= []).push( fct );
    }
</script>

<!-- ‚ö† En rouge, les cas d'exceptions (+ dans `UPDATE`, `SET` √©crit **avant** `WHERE`). -->


</frame-uca>

<frame-uca>

<div class="overlay">
  <div onslide="0" class="child1">
  1
  </div>
  <div onslide="1" class="child2">
  2<br/>3
  </div>
</div>

</frame-uca>

</html>